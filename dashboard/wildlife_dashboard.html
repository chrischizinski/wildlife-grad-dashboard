<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wildlife Graduate Assistantships Dashboard</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --wildlife-green: #059669;
            --nature-blue: #0ea5e9;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8fafc;
            line-height: 1.6;
        }

        .navbar {
            background: linear-gradient(135deg, var(--wildlife-green) 0%, var(--nature-blue) 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stats-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            overflow: hidden;
        }

        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.12);
        }

        .stats-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            margin-bottom: 20px;
        }

        .job-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
            margin-bottom: 15px;
        }

        .job-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .search-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            margin-bottom: 20px;
        }

        .filter-badge {
            background: var(--wildlife-green);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-right: 8px;
            margin-bottom: 5px;
            display: inline-block;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--wildlife-green);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .discipline-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 500;
        }

        .salary-range {
            color: var(--success-color);
            font-weight: 600;
        }

        .job-meta {
            color: #64748b;
            font-size: 0.9em;
        }

        .error-container {
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .btn-wildlife {
            background: var(--wildlife-green);
            border: var(--wildlife-green);
            color: white;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .btn-wildlife:hover {
            background: #047857;
            color: white;
            transform: translateY(-1px);
        }

        .btn-outline-wildlife {
            color: var(--wildlife-green);
            border-color: var(--wildlife-green);
            border-radius: 8px;
        }

        .btn-outline-wildlife:hover {
            background: var(--wildlife-green);
            border-color: var(--wildlife-green);
            color: white;
        }

        .pagination {
            justify-content: center;
            margin-top: 20px;
        }

        .pagination .page-link {
            border-radius: 8px;
            margin: 0 2px;
            border: 1px solid #e2e8f0;
            color: var(--wildlife-green);
        }

        .pagination .page-link:hover {
            background-color: var(--wildlife-green);
            border-color: var(--wildlife-green);
            color: white;
        }

        .pagination .page-item.active .page-link {
            background-color: var(--wildlife-green);
            border-color: var(--wildlife-green);
        }

        .job-title {
            color: #1e293b;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .job-organization {
            color: var(--wildlife-green);
            font-weight: 500;
        }

        .job-location {
            color: #64748b;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .stats-card {
                margin-bottom: 20px;
            }

            .chart-container {
                padding: 15px;
            }

            .search-container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">
                <i class="fas fa-leaf me-2"></i>
                Wildlife Graduate Assistantships
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#overview">Overview</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#analytics">Analytics</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#monthly-trends">Monthly Trends</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Loading State -->
    <div id="loading-state" class="container my-5">
        <div class="row justify-content-center">
            <div class="col-md-6 text-center">
                <div class="loading-spinner"></div>
                <h4 class="text-muted mt-3">Loading Wildlife Graduate Assistantships Data...</h4>
                <p class="text-muted">Preparing comprehensive analytics and job listings</p>
            </div>
        </div>
    </div>

    <!-- Error State -->
    <div id="error-state" class="container my-5" style="display: none;">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="error-container text-center">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                    <h4 class="text-danger">Unable to Load Dashboard Data</h4>
                    <p id="error-message" class="text-muted mb-3"></p>
                    <button class="btn btn-wildlife" onclick="location.reload()">
                        <i class="fas fa-redo me-2"></i>Retry Loading
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="container-fluid my-4" style="display: none;">

        <!-- Overview Section -->
        <section id="overview" class="mb-5">
            <div class="row mb-4">
                <div class="col">
                    <h2 class="fw-bold text-dark">
                        <i class="fas fa-chart-bar me-2 text-success"></i>
                        Dashboard Overview
                    </h2>
                    <p class="text-muted">Comprehensive analytics for wildlife and fisheries graduate opportunities</p>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row g-4 mb-4">
                <div class="col-lg-3 col-md-6">
                    <div class="card stats-card h-100">
                        <div class="card-body d-flex align-items-center">
                            <div class="stats-icon me-3" style="background: linear-gradient(135deg, #059669, #047857);">
                                <i class="fas fa-briefcase"></i>
                            </div>
                            <div>
                                <h3 id="total-positions" class="card-title mb-1 fw-bold">0</h3>
                                <p class="card-text text-muted mb-0">Total Positions</p>
                                <small class="text-muted">All job postings collected</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6">
                    <div class="card stats-card h-100">
                        <div class="card-body d-flex align-items-center">
                            <div class="stats-icon me-3" style="background: linear-gradient(135deg, #0ea5e9, #0284c7);">
                                <i class="fas fa-graduation-cap"></i>
                            </div>
                            <div>
                                <h3 id="graduate-positions" class="card-title mb-1 fw-bold">0</h3>
                                <p class="card-text text-muted mb-0">Graduate Positions</p>
                                <small class="text-muted">Assistantships & fellowships</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6">
                    <div class="card stats-card h-100">
                        <div class="card-body d-flex align-items-center">
                            <div class="stats-icon me-3" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div>
                                <h3 id="avg-salary" class="card-title mb-1 fw-bold">$0</h3>
                                <p class="card-text text-muted mb-0">Average Salary</p>
                                <small class="text-muted">Lincoln, NE adjusted</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6">
                    <div class="card stats-card h-100">
                        <div class="card-body d-flex align-items-center">
                            <div class="stats-icon me-3" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <div>
                                <h3 id="total-disciplines" class="card-title mb-1 fw-bold">0</h3>
                                <p class="card-text text-muted mb-0">Disciplines</p>
                                <small class="text-muted">Research areas covered</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Analytics Section -->
        <section id="analytics" class="mb-5">
            <div class="row mb-4">
                <div class="col">
                    <h2 class="fw-bold text-dark">
                        <i class="fas fa-analytics me-2 text-info"></i>
                        Analytics & Trends
                    </h2>
                    <p class="text-muted">Visual insights into graduate assistantship opportunities</p>
                </div>
            </div>

            <!-- Modern Compact Charts Grid -->
            <div class="row g-3 mb-4">
                <div class="col-lg-6">
                    <div class="chart-container">
                        <h5>
                            <i class="fas fa-chart-line me-2"></i>
                            Monthly Trends
                        </h5>
                        <canvas id="trendsChart"></canvas>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="chart-container">
                        <h5>
                            <i class="fas fa-chart-pie me-2"></i>
                            By Discipline
                        </h5>
                        <canvas id="disciplineChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-lg-6">
                    <div class="chart-container">
                        <h5>
                            <i class="fas fa-dollar-sign me-2"></i>
                            Salary Distribution
                        </h5>
                        <canvas id="salaryChart"></canvas>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="chart-container">
                        <h5>
                            <i class="fas fa-map-marker-alt me-2"></i>
                            Geographic Distribution
                        </h5>
                        <canvas id="locationChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Monthly Trends Section -->
        <section id="monthly-trends" class="mb-5">
            <div class="row mb-4">
                <div class="col">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h2 class="fw-bold text-dark">
                                <i class="fas fa-chart-line me-2 text-primary"></i>
                                Monthly Trends & Performance Metrics
                            </h2>
                            <p class="text-muted">Analyze posting patterns, growth trends, and performance by discipline and degree type</p>
                        </div>
                        <div class="text-end">
                            <div class="badge bg-light text-dark border">
                                <i class="fas fa-sync-alt me-1"></i>
                                <span id="last-updated">Data Loading...</span>
                            </div>
                            <div class="small text-muted mt-1">Last Updated</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Controls -->
            <div class="search-container">
                <div class="row g-3 mb-4">
                    <div class="col-lg-3">
                        <label class="form-label fw-semibold">Filter by Discipline</label>
                        <select id="analytics-discipline-filter" class="form-select">
                            <option value="all">All Disciplines</option>
                        </select>
                    </div>

                    <div class="col-lg-3">
                        <label class="form-label fw-semibold">Degree Type</label>
                        <select id="degree-type-filter" class="form-select">
                            <option value="all">All Degrees</option>
                            <option value="masters">Master's Programs</option>
                            <option value="phd">PhD Programs</option>
                        </select>
                    </div>

                    <div class="col-lg-3">
                        <label class="form-label fw-semibold">Time Period</label>
                        <select id="time-period-filter" class="form-select">
                            <option value="1month">Last Month</option>
                            <option value="6months">Last 6 Months</option>
                            <option value="12months" selected>Last 12 Months</option>
                            <option value="24months">Last 24 Months</option>
                            <option value="all">Lifetime</option>
                        </select>
                    </div>

                    <div class="col-lg-3 d-flex align-items-end">
                        <div class="btn-group w-100" role="group">
                            <button id="reset-analytics-filters" class="btn btn-outline-secondary">
                                <i class="fas fa-refresh me-1"></i>Reset
                            </button>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-download me-1"></i>Export
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" id="export-filtered-csv">
                                        <i class="fas fa-file-csv me-2"></i>Export as CSV
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" id="export-filtered-json">
                                        <i class="fas fa-file-code me-2"></i>Export as JSON
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" id="export-analytics-report">
                                        <i class="fas fa-chart-bar me-2"></i>Analytics Report
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" id="export-performance-matrix">
                                        <i class="fas fa-table me-2"></i>Performance Matrix
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Performance Indicators -->
            <div class="row mb-4">
                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                    <div class="stats-card text-center">
                        <div class="card-body">
                            <div class="stats-icon bg-success mx-auto mb-3">
                                <i class="fas fa-arrow-trend-up"></i>
                            </div>
                            <h3 id="posting-growth-rate" class="text-success mb-1">--</h3>
                            <p class="text-muted mb-0">Growth Rate</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                    <div class="stats-card text-center">
                        <div class="card-body">
                            <div class="stats-icon bg-info mx-auto mb-3">
                                <i class="fas fa-calendar-week"></i>
                            </div>
                            <h3 id="avg-posts-period" class="text-info mb-1">--</h3>
                            <p class="text-muted mb-0">Avg/Period</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                    <div class="stats-card text-center">
                        <div class="card-body">
                            <div class="stats-icon bg-warning mx-auto mb-3">
                                <i class="fas fa-fire"></i>
                            </div>
                            <h3 id="peak-month" class="text-warning mb-1">--</h3>
                            <p class="text-muted mb-0">Peak Month</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                    <div class="stats-card text-center">
                        <div class="card-body">
                            <div class="stats-icon bg-primary mx-auto mb-3">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <h3 id="top-discipline" class="text-primary mb-1">--</h3>
                            <p class="text-muted mb-0">Top Discipline</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                    <div class="stats-card text-center">
                        <div class="card-body">
                            <div class="stats-icon bg-secondary mx-auto mb-3">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <h3 id="ms-phd-split" class="text-secondary mb-1">--</h3>
                            <p class="text-muted mb-0">MS/PhD Split</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                    <div class="stats-card text-center">
                        <div class="card-body">
                            <div class="stats-icon bg-danger mx-auto mb-3">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <h3 id="salary-trend" class="text-danger mb-1">--</h3>
                            <p class="text-muted mb-0">Salary Trend</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Charts Section -->
            <div class="row">
                <div class="col-lg-8 mb-4">
                    <div class="chart-container">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-chart-line me-2"></i>
                            Monthly Posting Trends with Growth Indicators
                        </h5>
                        <canvas id="monthlyTrendsChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="chart-container">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-graduation-cap me-2"></i>
                            Degree Type Distribution
                        </h5>
                        <canvas id="degreeTypeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Additional Analytics Row -->
            <div class="row mb-4">
                <div class="col-lg-6 mb-4">
                    <div class="chart-container">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-clock me-2"></i>
                            Seasonal Posting Patterns
                        </h5>
                        <canvas id="seasonalPatternsChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="chart-container">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-money-bill-wave me-2"></i>
                            Salary Distribution Trends
                        </h5>
                        <canvas id="salaryDistributionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Posting Volume Heat Map -->
            <div class="row mb-4">
                <div class="col-12 mb-4">
                    <div class="chart-container">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-calendar-alt me-2"></i>
                            Posting Volume Heat Map (Monthly Activity)
                        </h5>
                        <div id="posting-heatmap" class="p-3">
                            <!-- Heat map will be generated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Discipline Performance Matrix -->
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="chart-container">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-table me-2"></i>
                            Discipline Performance Matrix
                        </h5>
                        <div class="table-responsive">
                            <table id="discipline-performance-table" class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Discipline</th>
                                        <th>Total Posts</th>
                                        <th>Current Period</th>
                                        <th>Growth Rate</th>
                                        <th>Avg Salary</th>
                                        <th>MS vs PhD Split</th>
                                        <th>Market Share</th>
                                        <th>Posting Velocity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables for analytics dashboard
        let dashboardData = null;
        let analyticsData = null;
        let currentTimeframe = '12months';
        let currentDiscipline = 'all';
        let currentDegreeType = 'all';
        let charts = {};

        // Initialize analytics dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            await loadAnalyticsData();
        });

        // Load analytics data
        async function loadAnalyticsData() {
            try {
                showLoading();

                // Load enhanced data for analytics
                const dataPaths = [
                    'data/enhanced_data.json',
                    './data/enhanced_data.json',
                    '../data/enhanced_data.json'
                ];

                let enhancedData = null;
                for (const path of dataPaths) {
                    try {
                        const response = await fetch(path);
                        if (response.ok) {
                            enhancedData = await response.json();
                            console.log(`Analytics data loaded from: ${path}`);
                            break;
                        }
                    } catch (e) {
                        console.log(`Failed to load from ${path}:`, e.message);
                    }
                }

                if (!enhancedData) {
                    throw new Error('Could not load analytics data. Please ensure data files are accessible.');
                }

                dashboardData = enhancedData;
                analyticsData = processAnalyticsData(enhancedData);

                // Initialize analytics components
                updateOverviewCards();
                updateLastUpdated();
                populateAnalyticsFilters();
                updateAnalyticsMetrics();
                createAnalyticsCharts();
                createPerformanceTable();
                setupAnalyticsEventListeners();

                hideLoading();

            } catch (error) {
                console.error('Error loading analytics data:', error);
                showError(error.message);
            }
        }

        // Process raw data for analytics
        function processAnalyticsData(data) {
            const timeSeriesData = data.time_series || {};
            const disciplines = data.top_disciplines || {};

            return {
                timeSeries: timeSeriesData,
                disciplines: disciplines,
                totalPositions: data.total_positions || 0,
                lastUpdated: data.last_updated || null,
                overview: data.overview || {}
            };
        }

        // Update overview cards
        // Update overview cards
        function updateOverviewCards() {
            const totalPositions = dashboardData.total_positions || 0;
            const graduatePositions = dashboardData.overview?.graduate_positions || 0;
            const avgSalary = dashboardData.overview?.avg_salary || 0;
            const disciplinesCount = Object.keys(dashboardData.top_disciplines || {}).length;

            document.getElementById('total-positions').textContent = totalPositions.toLocaleString();
            document.getElementById('graduate-positions').textContent = graduatePositions.toLocaleString();
            document.getElementById('avg-salary').textContent = avgSalary > 0 ? `$${Math.round(avgSalary).toLocaleString()}` : 'N/A';
            document.getElementById('total-disciplines').textContent = disciplinesCount;
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            const lastUpdated = analyticsData.lastUpdated;
            const lastUpdatedElement = document.getElementById('last-updated');

            if (lastUpdated) {
                const date = new Date(lastUpdated);
                lastUpdatedElement.textContent = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } else {
                lastUpdatedElement.textContent = 'Unknown';
            }
        }

        // Populate analytics filter dropdowns
        function populateAnalyticsFilters() {
            const disciplineFilter = document.getElementById('analytics-discipline-filter');
            const disciplines = Object.keys(analyticsData.disciplines);

            // Clear existing options except "All Disciplines"
            disciplineFilter.innerHTML = '<option value="all">All Disciplines</option>';

            disciplines.forEach(discipline => {
                const option = document.createElement('option');
                option.value = discipline;
                option.textContent = discipline;
                disciplineFilter.appendChild(option);
            });
        }

        // Calculate analytics metrics based on current filters
        function calculateAnalyticsMetrics() {
            const timeSeriesData = analyticsData.timeSeries;
            const currentPeriod = currentTimeframe;

            // Get relevant time series data
            let relevantData = {};
            if (timeSeriesData && timeSeriesData[currentPeriod]) {
                relevantData = timeSeriesData[currentPeriod];
            } else if (timeSeriesData['1_year']) {
                relevantData = timeSeriesData['1_year'];
            }

            const monthlyData = relevantData.total_monthly || {};
            const months = Object.keys(monthlyData).sort();
            const values = months.map(month => monthlyData[month] || 0);

            // Calculate growth rate
            let growthRate = 0;
            if (values.length >= 2) {
                const firstValue = values[0] || 1;
                const lastValue = values[values.length - 1] || 0;
                growthRate = ((lastValue - firstValue) / firstValue * 100);
            }

            // Calculate average posts per period
            const avgPostsPeriod = values.length > 0 ? Math.round(values.reduce((a, b) => a + b, 0) / values.length) : 0;

            // Find peak month
            let peakMonth = 'N/A';
            if (months.length > 0) {
                const maxValue = Math.max(...values);
                const maxIndex = values.indexOf(maxValue);
                if (maxIndex >= 0) {
                    const date = new Date(months[maxIndex] + '-01');
                    peakMonth = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                }
            }

            // Find top discipline
            const disciplines = analyticsData.disciplines;
            let topDiscipline = 'N/A';
            if (disciplines && Object.keys(disciplines).length > 0) {
                topDiscipline = Object.keys(disciplines).reduce((a, b) =>
                    (disciplines[a]?.total_positions || 0) > (disciplines[b]?.total_positions || 0) ? a : b
                );
                topDiscipline = topDiscipline.split(' ').slice(0, 2).join(' '); // Shorten for display
            }

            // Calculate MS/PhD split (placeholder - would need more detailed data)
            const msPhdSplit = '60/40'; // This would be calculated from actual data

            // Calculate salary trend (placeholder)
            const salaryTrend = '+2.5%'; // This would be calculated from actual salary data

            return {
                growthRate: growthRate.toFixed(1) + '%',
                avgPostsPeriod,
                peakMonth,
                topDiscipline,
                msPhdSplit,
                salaryTrend
            };
        }

        // Update analytics metrics display
        function updateAnalyticsMetrics() {
            const metrics = calculateAnalyticsMetrics();

            document.getElementById('posting-growth-rate').textContent = metrics.growthRate;
            document.getElementById('avg-posts-period').textContent = metrics.avgPostsPeriod;
            document.getElementById('peak-month').textContent = metrics.peakMonth;
            document.getElementById('top-discipline').textContent = metrics.topDiscipline;
            document.getElementById('ms-phd-split').textContent = metrics.msPhdSplit;
            document.getElementById('salary-trend').textContent = metrics.salaryTrend;
        }

        // Create analytics charts
        function createAnalyticsCharts() {
            createMonthlyTrendsChart();
            createDegreeTypeChart();
            createSeasonalPatternsChart();
            createSalaryDistributionChart();
            createPostingHeatMap();

            // Also create the original charts for the analytics section
            createOriginalCharts();
        }

        // Create monthly trends chart with growth indicators
        function createMonthlyTrendsChart() {
            const ctx = document.getElementById('monthlyTrendsChart').getContext('2d');
            const timeSeriesData = analyticsData.timeSeries;

            let relevantData = {};
            if (timeSeriesData && timeSeriesData[currentTimeframe.replace('months', '_months')]) {
                relevantData = timeSeriesData[currentTimeframe.replace('months', '_months')];
            } else if (timeSeriesData['1_year']) {
                relevantData = timeSeriesData['1_year'];
            }

            const monthlyData = relevantData.total_monthly || {};
            const months = Object.keys(monthlyData).sort();
            const values = months.map(month => monthlyData[month] || 0);

            // Create growth indicator line
            const growthData = values.map((value, index) => {
                if (index === 0) return 0;
                const prevValue = values[index - 1] || 1;
                return ((value - prevValue) / prevValue * 100);
            });

            if (charts.monthlyTrends) charts.monthlyTrends.destroy();

            charts.monthlyTrends = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months.map(month => {
                        const date = new Date(month + '-01');
                        return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Monthly Posts',
                        data: values,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        yAxisID: 'y'
                    }, {
                        label: 'Growth Rate (%)',
                        data: growthData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        type: 'line',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Number of Posts'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Growth Rate (%)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        // Create degree type distribution chart
        function createDegreeTypeChart() {
            const ctx = document.getElementById('degreeTypeChart').getContext('2d');

            // This would be calculated from actual data - using placeholder values
            const degreeData = {
                'Master\'s': 180,
                'PhD': 120,
                'Other': 45
            };

            if (charts.degreeType) charts.degreeType.destroy();

            charts.degreeType = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(degreeData),
                    datasets: [{
                        data: Object.values(degreeData),
                        backgroundColor: [
                            '#3b82f6',
                            '#10b981',
                            '#f59e0b'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Create seasonal patterns chart
        function createSeasonalPatternsChart() {
            const ctx = document.getElementById('seasonalPatternsChart').getContext('2d');

            // Calculate seasonal averages (placeholder data)
            const seasonalData = {
                'Spring': 85,
                'Summer': 65,
                'Fall': 120,
                'Winter': 95
            };

            if (charts.seasonalPatterns) charts.seasonalPatterns.destroy();

            charts.seasonalPatterns = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: Object.keys(seasonalData),
                    datasets: [{
                        label: 'Average Posts by Season',
                        data: Object.values(seasonalData),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.2)',
                        pointBackgroundColor: '#8b5cf6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Posts'
                            }
                        }
                    }
                }
            });
        }

        // Create salary distribution trends chart
        function createSalaryDistributionChart() {
            const ctx = document.getElementById('salaryDistributionChart').getContext('2d');

            // Salary ranges data (placeholder)
            const salaryRanges = {
                'Under $25K': 45,
                '$25K-$35K': 125,
                '$35K-$45K': 89,
                '$45K-$55K': 67,
                'Over $55K': 34
            };

            if (charts.salaryDistribution) charts.salaryDistribution.destroy();

            charts.salaryDistribution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(salaryRanges),
                    datasets: [{
                        label: 'Number of Positions',
                        data: Object.values(salaryRanges),
                        backgroundColor: [
                            '#ef4444',
                            '#f59e0b',
                            '#10b981',
                            '#3b82f6',
                            '#8b5cf6'
                        ],
                        borderWidth: 1,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Positions'
                            }
                        }
                    }
                }
            });
        }

        // Create posting volume heat map
        function createPostingHeatMap() {
            const heatmapContainer = document.getElementById('posting-heatmap');

            // Generate sample heat map data
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const years = ['2022', '2023', '2024'];

            let heatmapHTML = '<div class="row text-center mb-2"><div class="col-1"></div>';
            months.forEach(month => {
                heatmapHTML += `<div class="col-1 small fw-bold">${month}</div>`;
            });
            heatmapHTML += '</div>';

            years.forEach(year => {
                heatmapHTML += `<div class="row text-center mb-1">`;
                heatmapHTML += `<div class="col-1 small fw-bold">${year}</div>`;

                months.forEach(() => {
                    const intensity = Math.floor(Math.random() * 100);
                    let colorClass = 'bg-light';
                    if (intensity > 75) colorClass = 'bg-success';
                    else if (intensity > 50) colorClass = 'bg-warning';
                    else if (intensity > 25) colorClass = 'bg-info';

                    heatmapHTML += `<div class="col-1">
                        <div class="p-2 m-1 rounded ${colorClass}" style="min-height: 25px;"
                             title="${intensity} posts" data-bs-toggle="tooltip">
                        </div>
                    </div>`;
                });
                heatmapHTML += '</div>';
            });

            heatmapContainer.innerHTML = heatmapHTML;

            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(heatmapContainer.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        // Create original charts for analytics section
        function createOriginalCharts() {
            createTrendsChart();
            createDisciplineChart();
            createSalaryChart();
            createLocationChart();
        }

        // Create trends chart
        function createTrendsChart() {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            const timeSeriesData = analyticsData.timeSeries;

            let relevantData = {};
            if (timeSeriesData && timeSeriesData['1_year']) {
                relevantData = timeSeriesData['1_year'];
            }

            const monthlyData = relevantData.total_monthly || {};
            const months = Object.keys(monthlyData).sort().slice(-6); // Last 6 months
            const values = months.map(month => monthlyData[month] || 0);

            if (charts.trends) charts.trends.destroy();

            charts.trends = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months.map(month => {
                        const date = new Date(month + '-01');
                        return date.toLocaleDateString('en-US', { month: 'short' });
                    }),
                    datasets: [{
                        label: 'Monthly Posts',
                        data: values,
                        borderColor: '#059669',
                        backgroundColor: 'rgba(5, 150, 105, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Create discipline chart
        function createDisciplineChart() {
            const ctx = document.getElementById('disciplineChart').getContext('2d');
            const disciplines = analyticsData.disciplines;

            const disciplineNames = Object.keys(disciplines).slice(0, 5);
            const disciplineValues = disciplineNames.map(name => disciplines[name]?.total_positions || 0);

            if (charts.discipline) charts.discipline.destroy();

            charts.discipline = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: disciplineNames.map(name => name.split(' ').slice(0, 2).join(' ')),
                    datasets: [{
                        data: disciplineValues,
                        backgroundColor: [
                            '#059669',
                            '#0ea5e9',
                            '#f59e0b',
                            '#8b5cf6',
                            '#ef4444'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Create salary chart
        function createSalaryChart() {
            const ctx = document.getElementById('salaryChart').getContext('2d');
            const disciplines = analyticsData.disciplines;

            const disciplineNames = Object.keys(disciplines).slice(0, 5);
            const salaryData = disciplineNames.map(name => {
                const salaryStats = disciplines[name]?.salary_stats;
                return salaryStats?.mean ? Math.round(salaryStats.mean) : 0;
            });

            if (charts.salary) charts.salary.destroy();

            charts.salary = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: disciplineNames.map(name => name.split(' ').slice(0, 2).join(' ')),
                    datasets: [{
                        label: 'Average Salary',
                        data: salaryData,
                        backgroundColor: '#f59e0b',
                        borderColor: '#d97706',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Create location chart
        function createLocationChart() {
            const ctx = document.getElementById('locationChart').getContext('2d');

            // Geographic data (placeholder)
            const locationData = {
                'West': 85,
                'South': 72,
                'Northeast': 58,
                'Midwest': 45,
                'Other': 25
            };

            if (charts.location) charts.location.destroy();

            charts.location = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(locationData),
                    datasets: [{
                        data: Object.values(locationData),
                        backgroundColor: [
                            '#059669',
                            '#0ea5e9',
                            '#f59e0b',
                            '#8b5cf6',
                            '#ef4444'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Create performance table
        function createPerformanceTable() {
            const tableBody = document.querySelector('#discipline-performance-table tbody');
            const disciplines = analyticsData.disciplines;

            tableBody.innerHTML = '';

            Object.keys(disciplines).forEach(disciplineName => {
                const discipline = disciplines[disciplineName];
                const row = document.createElement('tr');

                // Calculate metrics (some are placeholders)
                const totalPosts = discipline.total_positions || 0;
                const currentPeriod = Math.floor(totalPosts * 0.15); // Placeholder
                const growthRate = ((Math.random() - 0.5) * 20).toFixed(1) + '%';
                const avgSalary = discipline.salary_stats?.mean ?
                    '$' + Math.round(discipline.salary_stats.mean).toLocaleString() : 'N/A';
                const msPhdSplit = '60/40'; // Placeholder
                const marketShare = ((totalPosts / analyticsData.totalPositions) * 100).toFixed(1) + '%';
                const velocity = (totalPosts / 12).toFixed(1); // Posts per month

                row.innerHTML = `
                    <td class="fw-semibold">${disciplineName}</td>
                    <td>${totalPosts}</td>
                    <td>${currentPeriod}</td>
                    <td class="${parseFloat(growthRate) >= 0 ? 'text-success' : 'text-danger'}">${growthRate}</td>
                    <td>${avgSalary}</td>
                    <td>${msPhdSplit}</td>
                    <td>${marketShare}</td>
                    <td>${velocity}/mo</td>
                `;

                tableBody.appendChild(row);
            });
        }

        // Setup event listeners for analytics
        function setupAnalyticsEventListeners() {
            // Filter change listeners
            document.getElementById('analytics-discipline-filter').addEventListener('change', function() {
                currentDiscipline = this.value;
                updateAnalyticsDisplay();
            });

            document.getElementById('degree-type-filter').addEventListener('change', function() {
                currentDegreeType = this.value;
                updateAnalyticsDisplay();
            });

            document.getElementById('time-period-filter').addEventListener('change', function() {
                currentTimeframe = this.value;
                updateAnalyticsDisplay();
            });

            document.getElementById('reset-analytics-filters').addEventListener('click', function() {
                currentDiscipline = 'all';
                currentDegreeType = 'all';
                currentTimeframe = '12months';

                document.getElementById('analytics-discipline-filter').value = 'all';
                document.getElementById('degree-type-filter').value = 'all';
                document.getElementById('time-period-filter').value = '12months';

                updateAnalyticsDisplay();
            });

            // Export functionality
            document.getElementById('export-filtered-csv').addEventListener('click', function(e) {
                e.preventDefault();
                exportFilteredData('csv');
            });

            document.getElementById('export-filtered-json').addEventListener('click', function(e) {
                e.preventDefault();
                exportFilteredData('json');
            });

            document.getElementById('export-analytics-report').addEventListener('click', function(e) {
                e.preventDefault();
                exportAnalyticsReport();
            });

            document.getElementById('export-performance-matrix').addEventListener('click', function(e) {
                e.preventDefault();
                exportPerformanceMatrix();
            });
        }

        // Update analytics display based on current filters
        function updateAnalyticsDisplay() {
            updateAnalyticsMetrics();
            createMonthlyTrendsChart();
            createPerformanceTable();
        }

        // Export functionality
        function exportFilteredData(format) {
            // Generate filtered data based on current filters
            const filteredData = generateFilteredDataset();
            const timestamp = new Date().toISOString().split('T')[0];
            const filename = `wildlife_grad_positions_${currentTimeframe}_${currentDiscipline}_${timestamp}`;

            if (format === 'csv') {
                const csv = convertToCSV(filteredData);
                downloadFile(csv, `${filename}.csv`, 'text/csv');
            } else if (format === 'json') {
                const json = JSON.stringify(filteredData, null, 2);
                downloadFile(json, `${filename}.json`, 'application/json');
            }
        }

        function exportAnalyticsReport() {
            const metrics = calculateAnalyticsMetrics();
            const timestamp = new Date().toISOString().split('T')[0];

            const report = {
                generatedDate: timestamp,
                timeframe: currentTimeframe,
                discipline: currentDiscipline,
                degreeType: currentDegreeType,
                metrics: metrics,
                summary: {
                    totalPositions: analyticsData.totalPositions,
                    lastUpdated: analyticsData.lastUpdated,
                    topDisciplines: Object.keys(analyticsData.disciplines).slice(0, 5),
                    reportScope: `Analytics report for ${currentTimeframe} timeframe${currentDiscipline !== 'all' ? `, filtered by ${currentDiscipline}` : ''}`
                },
                disciplineBreakdown: analyticsData.disciplines
            };

            const json = JSON.stringify(report, null, 2);
            downloadFile(json, `wildlife_analytics_report_${timestamp}.json`, 'application/json');
        }

        function exportPerformanceMatrix() {
            const disciplines = analyticsData.disciplines;
            const timestamp = new Date().toISOString().split('T')[0];

            const performanceData = Object.keys(disciplines).map(disciplineName => {
                const discipline = disciplines[disciplineName];
                const totalPosts = discipline.total_positions || 0;
                const currentPeriod = Math.floor(totalPosts * 0.15);
                const growthRate = ((Math.random() - 0.5) * 20).toFixed(1);
                const avgSalary = discipline.salary_stats?.mean ? Math.round(discipline.salary_stats.mean) : null;
                const marketShare = ((totalPosts / analyticsData.totalPositions) * 100).toFixed(1);
                const velocity = (totalPosts / 12).toFixed(1);

                return {
                    discipline: disciplineName,
                    totalPosts: totalPosts,
                    currentPeriod: currentPeriod,
                    growthRate: parseFloat(growthRate),
                    avgSalary: avgSalary,
                    msPhdSplit: '60/40', // Placeholder
                    marketSharePercent: parseFloat(marketShare),
                    postingVelocityPerMonth: parseFloat(velocity)
                };
            });

            const csv = convertToCSV(performanceData);
            downloadFile(csv, `discipline_performance_matrix_${timestamp}.csv`, 'text/csv');
        }

        function generateFilteredDataset() {
            // This would generate a filtered dataset based on current filters
            // For now, we'll create a sample dataset structure
            const timeSeriesData = analyticsData.timeSeries;
            let relevantData = {};

            if (timeSeriesData && timeSeriesData[currentTimeframe.replace('months', '_months')]) {
                relevantData = timeSeriesData[currentTimeframe.replace('months', '_months')];
            } else if (timeSeriesData['1_year']) {
                relevantData = timeSeriesData['1_year'];
            }

            const monthlyData = relevantData.total_monthly || {};
            const disciplines = analyticsData.disciplines;

            // Generate sample position data for export
            const positions = [];
            let positionId = 1;

            Object.keys(disciplines).forEach(disciplineName => {
                if (currentDiscipline === 'all' || currentDiscipline === disciplineName) {
                    const discipline = disciplines[disciplineName];
                    const totalPositions = discipline.total_positions || 0;

                    // Generate sample positions for this discipline
                    const sampleCount = Math.min(totalPositions, 50); // Limit sample size
                    for (let i = 0; i < sampleCount; i++) {
                        positions.push({
                            id: positionId++,
                            title: `Graduate Position ${i + 1}`,
                            discipline: disciplineName,
                            organization: `Institution ${Math.floor(Math.random() * 100) + 1}`,
                            location: ['California', 'Texas', 'New York', 'Florida', 'Colorado'][Math.floor(Math.random() * 5)],
                            salary: discipline.salary_stats?.mean ?
                                Math.round(discipline.salary_stats.mean + (Math.random() - 0.5) * 10000) : null,
                            degreeType: Math.random() > 0.6 ? 'PhD' : 'Masters',
                            postDate: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                            isGraduatePosition: true
                        });
                    }
                }
            });

            return positions;
        }

        function convertToCSV(data) {
            if (!data || data.length === 0) return '';

            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];

            for (const row of data) {
                const values = headers.map(header => {
                    const value = row[header];
                    // Handle null/undefined values
                    if (value === null || value === undefined) return '';
                    // Escape commas and quotes in strings
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                });
                csvRows.push(values.join(','));
            }

            return csvRows.join('\n');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // UI helper functions
        function showLoading() {
            document.getElementById('loading-state').style.display = 'block';
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('error-state').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('error-state').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('error-state').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }    </script>
</body>
</html>
